(()=>{"use strict";var t=15,e=10,i=50,n=50,s=50,o=50,r="#4CAF50",a="#4CAF50",c="#FFC107",l="#F44336",h=120,u=60,d=30,m=50,p=35,v=2,g=function(){function a(r,a){void 0===a&&(a=!1),this.canvas=r,this.ctx=r.getContext("2d"),this.cellSize=a?p:m,this.boxSize=this.cellSize-2*v,this.canvas.width=t*this.cellSize+o+n,this.canvas.height=e*this.cellSize+i+s}return a.prototype.clear=function(){this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height)},a.prototype.drawGrid=function(){this.ctx.strokeStyle="#ddd",this.ctx.lineWidth=1;for(var n=0;n<=t;n++)this.ctx.beginPath(),this.ctx.moveTo(n*this.cellSize+o,i),this.ctx.lineTo(n*this.cellSize+o,e*this.cellSize+i),this.ctx.stroke();for(var s=0;s<=e;s++)this.ctx.beginPath(),this.ctx.moveTo(o,s*this.cellSize+i),this.ctx.lineTo(t*this.cellSize+o,s*this.cellSize+i),this.ctx.stroke()},a.prototype.drawTiles=function(t){var e=this;t.forEach((function(t){if(!t.isEmpty){var n=t.position.x+o-e.boxSize/2,s=t.position.y+i-e.boxSize/2;e.ctx.fillStyle=t.isSelected?"#FFC107":t.color||r,e.ctx.fillRect(n,s,e.boxSize,e.boxSize),e.ctx.strokeStyle=t.isSelected?"#FFA000":"#2E7D32",e.ctx.lineWidth=t.isSelected?2:1,e.ctx.strokeRect(n,s,e.boxSize,e.boxSize),e.ctx.fillStyle=e.getContrastColor(t.isSelected?"#FFC107":t.color||r),e.ctx.font="bold 22px Arial",e.ctx.textAlign="center",e.ctx.textBaseline="middle",e.ctx.fillText(t.value.toString(),n+e.boxSize/2,s+e.boxSize/2)}}))},a.prototype.drawSelection=function(t,e,n){var s=this,r=Math.min(t.x,e.x),a=Math.max(t.x,e.x),c=Math.min(t.y,e.y),l=Math.max(t.y,e.y);this.ctx.fillStyle="rgba(255, 255, 255, 0.3)",this.ctx.fillRect(r,c,a-r,l-c),this.ctx.strokeStyle="rgba(0, 0, 0, 0.8)",this.ctx.lineWidth=4,this.ctx.setLineDash([5,5]),this.ctx.strokeRect(r,c,a-r,l-c),n.forEach((function(t){if(!t.isEmpty){var e=t.position.x+o,n=t.position.y+i;if(e>=r&&e<=a&&n>=c&&n<=l){var h=t.position.x+o-s.boxSize/2,u=t.position.y+i-s.boxSize/2;s.ctx.setLineDash([]),s.ctx.strokeStyle="#FFC107",s.ctx.lineWidth=2,s.ctx.strokeRect(h,u,s.boxSize,s.boxSize)}}})),this.ctx.setLineDash([])},a.prototype.getContrastColor=function(t){return(299*parseInt(t.slice(1,3),16)+587*parseInt(t.slice(3,5),16)+114*parseInt(t.slice(5,7),16))/1e3>=128?"#000000":"#FFFFFF"},a}(),f=function(){return f=Object.assign||function(t){for(var e,i=1,n=arguments.length;i<n;i++)for(var s in e=arguments[i])Object.prototype.hasOwnProperty.call(e,s)&&(t[s]=e[s]);return t},f.apply(this,arguments)},y=function(){function n(t,e){void 0===e&&(e=m),this.state=t,this.cellSize=e}return n.prototype.generateTiles=function(){this.state.tiles=[];for(var i=0;i<e;i++)for(var n=0;n<t;n++){var s={x:n*this.cellSize+this.cellSize/2,y:i*this.cellSize+this.cellSize/2},o=Math.floor(9*Math.random())+1;this.state.tiles.push({position:s,value:o,color:this.state.currentColor,isEmpty:!1})}},n.prototype.checkSelection=function(t){var e=this.getTilesInSelection(t);if(e.length<2)return!1;var i=e[0].value,n=e.every((function(t){return t.value===i})),s=e.reduce((function(t,e){return t+e.value}),0);return!(!n&&10!==s||(this.state.score+=e.length,this.removeTiles(e),this.checkAndRefillBoard(),0))},n.prototype.getTilesInSelection=function(t){var e=t.start,n=t.end,s=Math.min(e.x,n.x),r=Math.max(e.x,n.x),a=Math.min(e.y,n.y),c=Math.max(e.y,n.y);return this.state.tiles.filter((function(t){var e=t.position.x+o,n=t.position.y+i;return!t.isEmpty&&e>=s&&e<=r&&n>=a&&n<=c}))},n.prototype.removeTiles=function(t){for(var e=0,i=t;e<i.length;e++){var n=i[e],s=this.state.tiles.indexOf(n);s>-1&&(this.state.tiles[s]=f(f({},n),{isEmpty:!0,value:0}))}},n.prototype.checkAndRefillBoard=function(){var t=this;this.state.tiles.every((function(t){return t.isEmpty}))&&(this.state.tiles=this.state.tiles.map((function(e){return f(f({},e),{isEmpty:!1,value:Math.floor(9*Math.random())+1,color:t.state.currentColor})})))},n.prototype.updateColor=function(t){var e=this;this.state.currentColor=t,this.state.tiles.length>0&&(this.state.tiles=this.state.tiles.map((function(t){return t.isEmpty?t:f(f({},t),{color:e.state.currentColor})})))},n.prototype.resetGame=function(){this.state.score=0,this.state.timeRemaining=h,this.state.selection=void 0,this.generateTiles()},n}(),E=function(){function t(t,e,i,n,s){void 0===s&&(s=!1),this.canvas=t,this.state=e,this.onSelectionChange=i,this.onSelectionEnd=n,this.isMobile=s,this.isEnabled=!0,this.isDragging=!1,this.setupEventListeners()}return t.prototype.setupEventListeners=function(){this.isMobile&&this.setupTouchEvents(),this.setupMouseEvents()},t.prototype.setupTouchEvents=function(){var t=this;this.canvas.addEventListener("touchstart",(function(e){if(e.preventDefault(),t.isEnabled){var i=e.touches[0],n=t.getTouchPos(i);t.startDragging(n),t.canvas.classList.add("touch-active")}}),{passive:!1}),this.canvas.addEventListener("touchmove",(function(e){if(e.preventDefault(),t.isEnabled&&t.isDragging&&t.state.selection){var i=e.touches[0],n=t.getTouchPos(i);t.updateSelection(n)}}),{passive:!1}),this.canvas.addEventListener("touchend",(function(e){e.preventDefault(),t.isEnabled&&(t.endDragging(),t.canvas.classList.remove("touch-active"))}),{passive:!1})},t.prototype.setupMouseEvents=function(){var t=this;this.canvas.addEventListener("mousedown",(function(e){return t.handleMouseDown(e)})),this.canvas.addEventListener("mousemove",(function(e){return t.handleMouseMove(e)})),this.canvas.addEventListener("mouseup",(function(){return t.handleMouseUp()}))},t.prototype.startDragging=function(t){this.isDragging=!0,this.state.selection={start:t,end:t},this.onSelectionChange(t,t)},t.prototype.updateSelection=function(t){this.state.selection&&(this.state.selection.end=t,this.onSelectionChange(this.state.selection.start,t))},t.prototype.endDragging=function(){this.state.selection&&this.onSelectionEnd(),this.isDragging=!1,this.state.selection=void 0},t.prototype.getMousePos=function(t){var e=this.canvas.getBoundingClientRect();return{x:t.clientX-e.left,y:t.clientY-e.top}},t.prototype.getTouchPos=function(t){var e=this.canvas.getBoundingClientRect(),r=this.canvas.width/e.width,a=this.canvas.height/e.height,c=(t.clientX-e.left)*r-(this.isMobile?10:0),l=(t.clientY-e.top)*a-(this.isMobile?10:0);return{x:Math.max(o,Math.min(c,this.canvas.width-n)),y:Math.max(i,Math.min(l,this.canvas.height-s))}},t.prototype.disable=function(){this.isEnabled=!1},t.prototype.enable=function(){this.isEnabled=!0},t.prototype.handleMouseDown=function(t){if(this.isEnabled){var e=this.getMousePos(t);this.startDragging(e)}},t.prototype.handleMouseMove=function(t){if(this.isEnabled&&this.isDragging&&this.state.selection){var e=this.getMousePos(t);this.updateSelection(e)}},t.prototype.handleMouseUp=function(){this.isEnabled&&this.endDragging()},t}(),x=function(){function t(){this.timerElement=document.getElementById("timer"),this.scoreElement=document.getElementById("score"),this.gameOverElement=document.getElementById("gameOver"),this.finalScoreElement=document.getElementById("finalScore")}return t.prototype.updateTimer=function(t){this.timerElement&&(this.timerElement.textContent="".concat(t,"초"),this.updateTimerColor(t))},t.prototype.updateScore=function(t){this.scoreElement&&(this.scoreElement.textContent="점수: ".concat(t))},t.prototype.showGameOver=function(t){this.gameOverElement&&this.finalScoreElement&&(this.finalScoreElement.textContent=t.toString(),this.gameOverElement.style.display="block")},t.prototype.hideGameOver=function(){this.gameOverElement&&(this.gameOverElement.style.display="none")},t.prototype.resetTimer=function(){this.timerElement&&(this.timerElement.textContent="".concat(h,"초"),this.timerElement.style.color="#000000")},t.prototype.updateTimerColor=function(t){this.timerElement&&(this.timerElement.style.color=t>u?a:t>d?c:l)},t.prototype.resetScore=function(){var t=document.getElementById("score");t&&(t.textContent="점수: 0")},t}(),S=function(){function t(){var t=this;this.bgm=new Audio("assets/audio/bgm.mp3"),this.bgm.loop=!0,this.bgm.addEventListener("timeupdate",(function(){t.bgm.currentTime>t.bgm.duration-1.5&&(t.bgm.currentTime=0)}))}return t.prototype.playBGM=function(){this.bgm.play()},t.prototype.stopBGM=function(){this.bgm.pause(),this.bgm.currentTime=0},t.prototype.setBGMVolume=function(t){this.bgm.volume=Math.max(0,Math.min(1,t))},t}(),M=function(){function t(){}return t.setCookie=function(t,e,i){void 0===i&&(i=365);var n=new Date;n.setTime(n.getTime()+24*i*60*60*1e3);var s="expires=".concat(n.toUTCString());document.cookie="".concat(t,"=").concat(e,";").concat(s,";path=/")},t.getCookie=function(t){for(var e="".concat(t,"="),i=0,n=document.cookie.split(";");i<n.length;i++){var s=n[i];if(0===(s=s.trim()).indexOf(e))return s.substring(e.length,s.length)}return""},t}(),b=function(){function t(t){this.timerInterval=null,this.isBGMOn=!0;var e=document.getElementById(t.canvasId);if(!e)throw new Error("Canvas element not found");this.state={tiles:[],score:0,timeRemaining:h,currentColor:r},this.renderer=new g(e,t.isMobile);var i=t.isMobile?p:m;this.logic=new y(this.state,i),this.uiManager=new x,this.eventHandler=new E(e,this.state,this.handleSelectionChange.bind(this),this.handleSelectionEnd.bind(this),t.isMobile),this.audioManager=new S,this.setupGame(),this.setupBGMControl()}return t.prototype.setupGame=function(){this.setupStartScreen(),this.setupColorButtons(),this.setupGameControls()},t.prototype.setupStartScreen=function(){var t=this,e=document.getElementById("startButton"),i=document.getElementById("startScreen"),n=document.getElementById("gameScreen");null==e||e.addEventListener("click",(function(){i&&n&&(i.style.display="none",n.style.display="block",t.startGame())}))},t.prototype.setupColorButtons=function(){var t=this,e=document.querySelectorAll(".color-btn");e.forEach((function(i){i instanceof HTMLElement&&i.addEventListener("click",(function(){var n=i.dataset.color||r;t.logic.updateColor(n),e.forEach((function(t){return t.classList.remove("active")})),i.classList.add("active")}))}))},t.prototype.setupGameControls=function(){var t,e,i,n,s,o=this;null===(t=document.getElementById("cancelBtn"))||void 0===t||t.addEventListener("click",(function(){o.cancelGame()})),null===(e=document.getElementById("restartBtn"))||void 0===e||e.addEventListener("click",(function(){o.restartGame()})),null===(i=document.getElementById("shuffleBtn"))||void 0===i||i.addEventListener("click",(function(){o.logic.generateTiles()})),null===(n=document.getElementById("restartFromOver"))||void 0===n||n.addEventListener("click",(function(){o.uiManager.hideGameOver(),o.restartGame()})),null===(s=document.getElementById("homeFromOver"))||void 0===s||s.addEventListener("click",(function(){o.uiManager.hideGameOver(),o.cancelGame()}))},t.prototype.setupBGMControl=function(){var t=this,e=document.getElementById("bgmToggle"),i=document.getElementById("bgmVolume"),n=M.getCookie("bgmEnabled"),s=M.getCookie("bgmVolume");this.isBGMOn=!n||"true"===n,e.checked=this.isBGMOn;var o=s?parseInt(s)/100:.5;i.value=(100*o).toString(),this.audioManager.setBGMVolume(o),e.addEventListener("change",(function(){t.isBGMOn=e.checked,t.isBGMOn?t.audioManager.playBGM():t.audioManager.stopBGM(),M.setCookie("bgmEnabled",t.isBGMOn.toString())})),i.addEventListener("input",(function(){var e=parseInt(i.value)/100;t.audioManager.setBGMVolume(e),M.setCookie("bgmVolume",i.value)}))},t.prototype.startGame=function(){this.logic.resetGame(),this.eventHandler.enable(),this.startTimer(),this.gameLoop(),this.isBGMOn&&this.audioManager.playBGM()},t.prototype.cancelGame=function(){this.timerInterval&&(clearInterval(this.timerInterval),this.timerInterval=null),this.logic.resetGame(),this.uiManager.resetTimer(),this.uiManager.resetScore();var t=document.getElementById("gameScreen"),e=document.getElementById("startScreen");t&&e&&(t.style.display="none",e.style.display="block"),this.audioManager.stopBGM()},t.prototype.restartGame=function(){this.timerInterval&&(clearInterval(this.timerInterval),this.timerInterval=null),this.uiManager.resetTimer(),this.uiManager.resetScore(),this.startGame()},t.prototype.startTimer=function(){var t=this;this.timerInterval&&clearInterval(this.timerInterval),this.timerInterval=setInterval((function(){t.state.timeRemaining--,t.uiManager.updateTimer(t.state.timeRemaining),t.state.timeRemaining<=0&&(t.timerInterval&&clearInterval(t.timerInterval),t.endGame())}),1e3)},t.prototype.endGame=function(){this.timerInterval&&clearInterval(this.timerInterval),this.eventHandler.disable(),this.uiManager.showGameOver(this.state.score),this.audioManager.stopBGM()},t.prototype.handleSelectionChange=function(t,e){this.state.selection={start:t,end:e}},t.prototype.handleSelectionEnd=function(){this.state.selection&&(this.logic.checkSelection(this.state.selection),this.uiManager.updateScore(this.state.score))},t.prototype.gameLoop=function(){var t=this;this.renderer.clear(),this.renderer.drawGrid(),this.renderer.drawTiles(this.state.tiles),this.state.selection&&this.renderer.drawSelection(this.state.selection.start,this.state.selection.end,this.state.tiles),requestAnimationFrame((function(){return t.gameLoop()}))},t}();window.addEventListener("DOMContentLoaded",(function(){var t=window.innerWidth<=768;new b({canvasId:"gameCanvas",isMobile:t})}))})();